@using Console_InputApplication.ViewEvents;
@inherits LayoutComponentBase 
@using static Console_UserInterface.Shared.Forms.ValidationForm;
@inject ILogger<ValidationForm> Logger
@code{
    [Parameter]
    public InputFormModel Model { get; set; }

    [Parameter]
    public bool Border { get; set; }

    [Parameter]
    public EventCallback OnValidated { get; set; }

    [Parameter]
    public EventCallback OnChangedCallback { get; set; }

    bool Debug = false;
}
@code{
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Validate();
    }
    public Dictionary<string, List<string>> Valdiate(object p) => p.Validate();
    public void SetErrors(object model, Dictionary<string, List<string>> errors)
    {

    }
    protected async Task Validate()
    {
        var message = Model.Validate();
        SetErrors(Model, message);
        Model.FormFields.ForEach(item =>
        {
            item.State = message.ContainsKey(item.Name) && message[item.Name].Count() > 0 ? "invalid" : "valid";
        });
        this.Info(message.ToJson());
        if (Model.IsValid)
        {
            await OnValidated.InvokeAsync();
        }
        StateHasChanged();
    }
    [Parameter]
    public string Title { get; set; }
}
@if (Model == null)
{
    <ProgressAnimation></ProgressAnimation>
}
else
{
  
    <div class="btn"
         style="width: 100%; height: 90%;                  
                   overflow-y: auto;
                   padding: 20px;
                   border-radius: 2px; box-shadow: 0px 4px 3px -2px rgba(0, 0, 0, 0.4), 0px 2px 2px 0px rgba(0, 0, 0, 0.24), 0px 2px 6px 0px rgba(0, 0, 0, 0.22);">
        <p class="text-body-header">@(Title is not null ? Title : Model.Title)</p>
        <div class="text-black-50 text-info">@Model.Description</div>
       
        @if(Debug)
        { 
            <div class="text-black-50 text-success">@Model.Item.ToJsonOnScreen()</div>
        }
        <div class="text-black-50 text-danger">@Model.Error</div>
        <form>
            <div>
                @foreach (var field in Model.FormFields)
                {
                    <div style="padding: 3px;">
                        <FormControl Model="@field"
                                     AfterInput="@OnPropertyChanged"
                                />
                    </div>
                }

            </div>
        </form>
        
        <div style="padding: 5px;" align="right"> @Body </div>
    </div>
}
@functions
{
    public Dictionary<string, List<string>> ValidateOnInput(object model, InputEvent evt)
    {
        return new Dictionary<string, List<string>>();
    }
    public async Task OnPropertyChanged(InputEvent evt)
    {


        this.Info("OnPropertyChanged()");
        try
        {
            Dictionary<string, List<string>> message = ValidateOnInput(Model, evt);
            SetErrors(Model, message);
            Model.FormFields.ForEach(item =>
            {
                item.State = message.ContainsKey(item.Name) && message[item.Name].Count() > 0 ? "invalid" : "valid";
            });
            this.Info(message.ToJson());
            if (Model.IsValid)
            {
                await OnValidated.InvokeAsync();
            }
            StateHasChanged();
            
            await OnChangedCallback.InvokeAsync(this.Model.Item);
            
        }
        catch(Exception ex)
        {
            Model.Error = ex.Message;
        }


    }
}